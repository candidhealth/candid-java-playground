# GraalVM Native Image configuration for gRPC + Netty compatibility
#
# This configuration is critical for making gRPC work with GraalVM native-image.
# The main challenge is Netty's initialization timing - some classes must be
# initialized at runtime rather than build time to avoid issues with:
# - Event loops
# - Native libraries
# - Platform-specific code
#
# References:
# - https://github.com/grpc/grpc-java/issues/10781
# - https://www.graalvm.org/latest/reference-manual/native-image/metadata/

# Initialize Netty at runtime (critical for gRPC compatibility)
# Netty uses platform-specific code and native libraries that must be
# loaded at runtime, not build time
Args = --initialize-at-run-time=io.netty \
       --initialize-at-run-time=io.grpc.netty

# Initialize SLF4J at build time for better startup performance
Args += --initialize-at-build-time=org.slf4j

# Enable detailed exception stack traces in native image
Args += -H:+ReportExceptionStackTraces

# Include all charsets (needed for protobuf encoding)
Args += -H:+AddAllCharsets

# Enable HTTP/HTTPS protocol support (required for gRPC)
Args += --enable-url-protocols=http,https

# Enable HTTP/2 (required for gRPC)
Args += --enable-http

# Optimize for runtime speed (slight increase in image size)
Args += -O3

# Report dead code (helpful for debugging)
Args += -H:+ReportUnsupportedElementsAtRuntime
